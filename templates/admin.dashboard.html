<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard - Bus Tracking</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
:root {
  --primary: #0052cc;
  --primary-dark: #003a99;
  --secondary: #6b7280;
  --background: #f4f6f8;
  --surface: #ffffff;
  --text-primary: #111827;
  --text-secondary: #6b7280;
  --error: #e02424;
  --shadow-light: rgba(0,0,0,0.05);
  --shadow-strong: rgba(0,0,0,0.1);
  --border-radius: 12px;
  --transition-fast: 0.3s ease;
  --font-sans: 'Poppins', Arial, sans-serif;
  --dark-background: #111827;
  --dark-surface: #1f2937;
  --dark-text-primary: #f4f6f8;
  --dark-text-secondary: #d1d5db;
}

/* Body */
body {
  margin:0;
  font-family: var(--font-sans);
  background: var(--background);
  color: var(--text-primary);
  overflow-x: hidden;
  transition: background 0.4s ease, color 0.4s ease;
}

/* Dark mode */
body.dark {
  background: var(--dark-background);
  color: var(--dark-text-primary);
}

/* Header */
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background: var(--surface);
  padding:1rem 2rem;
  font-weight:600;
  color: var(--text-primary);
  box-shadow: 0 3px 10px var(--shadow-light);
  position: sticky;
  top: 0;
  z-index: 1000;
  border-bottom: 1px solid #e5e7eb;
  transition: background 0.3s ease, box-shadow 0.3s ease;
}

body.dark header {
  background: var(--dark-surface);
  color: var(--dark-text-primary);
}

header h1 {
  font-size: 1.5rem;
  font-weight:700;
  color: var(--primary);
}

body.dark header h1 {
  color: #60a5fa; /* softer blue for dark mode */
}

/* Header Buttons */
header button {
  padding: 15px;
  background: #60a5fa;
  border:none;
  border-radius: var(--border-radius);
  color:#fff;
  cursor:pointer;
  font-weight:600;
  margin-left:0.5rem;
  transition: all var(--transition-fast);
  position: relative;
  overflow: hidden;
}

header button::after {
  content:'';
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(255,255,255,0.1);
  opacity:0;
  transition: opacity 0.3s ease;
}

header button:hover::after {
  opacity:1;
}

header button:hover {
  background: var(--primary-dark);
  color: #fff;
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 8px 20px rgba(0, 82, 204, 0.5), 0 0 10px rgba(0, 82, 204, 0.6) inset;
}
/* Search Bar */
.search-bar {
  display:flex;
  justify-content:center;
  margin:1.5rem 0;
  opacity:0;
  transform: translateY(20px);
  animation: fadeInUp 0.5s forwards 0.2s;
}

.search-bar input {
  width:60%;
  padding:0.7rem 1rem;
  border-radius: var(--border-radius);
  border:1px solid #d1d5db;
  outline:none;
  font-size:1rem;
  transition: all 0.3s ease;
  background: var(--surface);
  color: var(--text-primary);
  box-shadow: 0 2px 6px var(--shadow-light);
}

body.dark .search-bar input {
  background: var(--dark-surface);
  color: var(--dark-text-primary);
  border-color: #374151;
}

.search-bar input:focus {
  border-color: var(--primary);
  box-shadow: 0 4px 14px var(--shadow-strong);
  transform: scale(1.01);
}

/* Students Container */
.students-container {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1.5rem;
  margin:1rem 2rem;
}

/* Student Card */
.student-card {
  background: var(--surface);
  padding:1.5rem;
  border-radius: var(--border-radius);
  box-shadow:0 2px 6px var(--shadow-light);
  position:relative;
  opacity:0;
  transform: translateY(15px);
  animation: fadeInUp 0.6s forwards;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast), background 0.3s ease, color 0.3s ease;
}

body.dark .student-card {
  background: var(--dark-surface);
  color: var(--dark-text-primary);
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.student-card:nth-child(1) { animation-delay: 0.1s; }
.student-card:nth-child(2) { animation-delay: 0.2s; }
.student-card:nth-child(3) { animation-delay: 0.3s; }
.student-card:nth-child(4) { animation-delay: 0.4s; }

.student-card:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 8px 20px var(--shadow-strong);
}

.student-card h3 {
  margin:0 0 0.5rem;
  color: var(--primary);
  font-size:1.1rem;
  font-weight:600;
  transition: color 0.3s ease;
}

body.dark .student-card h3 {
  color: #60a5fa;
}

.student-card p {
  margin:0.3rem 0;
  font-size:0.9rem;
  color: var(--text-secondary);
  transition: color 0.3s ease;
}

body.dark .student-card p {
  color: var(--dark-text-secondary);
}

/* Delete Button */
.delete-btn {
  position:absolute;
  top:10px;
  right:10px;
  background: var(--error);
  color:#fff;
  border:none;
  padding:0.35rem 0.7rem;
  border-radius: var(--border-radius);
  cursor:pointer;
  font-weight:600;
  transition: all var(--transition-fast);
}

.delete-btn:hover {
  background: #b71c1c;
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

/* Animations */
@keyframes fadeInUp {
  0% { opacity:0; transform: translateY(20px); }
  100% { opacity:1; transform: translateY(0); }
}

/* Responsive */
@media (max-width:480px){
  .search-bar input { width: 90%; }
  header { flex-direction: column; font-size:1.2rem; }
}


.students-container {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1.5rem;
  margin:1rem 2rem;
}

.student-card {
  background: #fff;
  padding:1.5rem;
  border-radius: 12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  position:relative; /* important for floating edit form */
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.student-card:hover {
  transform: translateY(-3px);
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
}

.delete-btn, .update-btn {
  margin:0.3rem 0.2rem 0 0;
  padding:0.4rem 0.8rem;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.delete-btn { background:#e02424; color:#fff; }
.update-btn { background:#0052cc; color:#fff; }

.delete-btn:hover { background:#b71c1c; }
.update-btn:hover { background:#003a99; }

.edit-form {
  position:absolute;
  top:10px;
  left:10px;
  right:10px;
  background: #f9f9f9;
  padding:1rem;
  border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,0.2);
  z-index:100;
}

.edit-form input {
  width:100%;
  padding:0.5rem;
  margin:0.3rem 0;
  border-radius:8px;
  border:1px solid #ccc;
}

.edit-form button {
  margin-top:0.5rem;
  padding:0.5rem 0.8rem;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.save-btn { background:#0052cc; color:#fff; }
.cancel-btn { background:#e02424; color:#fff; }

.save-btn:hover { background:#003a99; }
.cancel-btn:hover { background:#b71c1c; }

</style>
</head>
<body>

<header>
  <h1>üöç Admin Dashboard</h1>
  <div>
    <button id="darkModeToggle">Toggle Mode</button>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Search by name, email or bus number..."/>
</div>

<div id="studentsContainer" class="students-container">
  {% for user in users %}
<div class="student-card" data-id="{{ user.id }}" data-name="{{ user.name }}" data-email="{{ user.email }}" data-bus="{{ user.bus_number }}">

    <h3>{{ user.name }}</h3>
    <p><strong>Email:</strong> {{ user.email }}</p>
    <p><strong>Bus Number:</strong> {{ user.bus_number }}</p>
<button class="delete-btn" data-id="{{ user.id }}">Delete</button>
<button class="update-btn" data-id="{{ user.id }}">Update</button>
<!-- Hidden edit form -->
<div class="edit-form" style="display:none;">
  <input type="text" class="edit-name" value="{{ user.name }}">
  <input type="email" class="edit-email" value="{{ user.email }}">
  <input type="text" class="edit-bus" value="{{ user.bus_number }}">
  <button class="save-btn">Save</button>
  <button class="cancel-btn">Cancel</button>
</div>


  </div>
  {% endfor %}
</div>

<script>
// Dark mode toggle
const darkToggle = document.getElementById("darkModeToggle");
darkToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");

  // Animate button on click
  darkToggle.style.transform = "scale(0.95)";
  setTimeout(() => { darkToggle.style.transform = "scale(1)"; }, 150);
});

// Logout button animation
const logoutBtn = document.getElementById("logoutBtn");
logoutBtn.addEventListener("click", () => {
  logoutBtn.style.transform = "scale(0.95)";
  setTimeout(() => { logoutBtn.style.transform = "scale(1)"; }, 150);
  window.location.href = "{{ url_for('admin_login') }}";
});

// Search filter
document.getElementById("searchInput").addEventListener("input", function(){
  const filter = this.value.toLowerCase();
  document.querySelectorAll(".student-card").forEach(card => {
    const name = card.dataset.name.toLowerCase();
    const email = card.dataset.email.toLowerCase();
    const bus = card.dataset.bus.toLowerCase();
    card.style.display = (name.includes(filter) || email.includes(filter) || bus.includes(filter)) ? "block" : "none";
  });
});

// Delete functionality
document.querySelectorAll(".delete-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const card = this.closest(".student-card");
    const userId = card.dataset.id;
    if(confirm("Are you sure you want to delete this user?")) {
      fetch(`/delete_user/${userId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if(data.success) card.remove();
          else alert("Failed to delete user.");
        })
        .catch(() => alert("Server error while deleting user."));
    }
  });
});

// Show edit form
document.querySelectorAll(".update-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const card = this.closest(".student-card");
    const form = card.querySelector(".edit-form");
    form.style.display = "block";
  });
});

// Cancel edit
document.querySelectorAll(".cancel-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const form = this.closest(".edit-form");
    form.style.display = "none";
  });
});

// Save edit
document.querySelectorAll(".save-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const form = this.closest(".edit-form");
    const card = this.closest(".student-card");
    const userId = card.dataset.id;

    const name = form.querySelector(".edit-name").value.trim();
    const email = form.querySelector(".edit-email").value.trim();
    const bus_number = form.querySelector(".edit-bus").value.trim();

    if(!name || !email || !bus_number){
        alert("All fields are required!");
        return;
    }

    console.log("Updating user:", userId, name, email, bus_number);

    fetch(`/update_user/${userId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, bus_number })
    })
    .then(res => res.json())
    .then(data => {
      console.log("Response:", data);
      if(data.success){
        card.querySelector("h3").textContent = name;
        card.querySelector("p:nth-of-type(1)").innerHTML = `<strong>Email:</strong> ${email}`;
        card.querySelector("p:nth-of-type(2)").innerHTML = `<strong>Bus Number:</strong> ${bus_number}`;
        card.dataset.name = name;
        card.dataset.email = email;
        card.dataset.bus = bus_number;
        form.style.display = "none";
        alert("‚úÖ User updated successfully!");
      } else {
        alert(`‚ùå Failed to update user: ${data.error || 'Unknown error'}`);
      }
    })
    .catch(err => {
      console.error(err);
      alert("‚ö†Ô∏è Server error while updating user.");
    });
  });
});

</script>
</body>
</html>
